{"mode":"editor","version":1,"windowDimensions":{"x":291,"y":1104,"width":1366,"height":744,"maximized":true},"grammars":{"deserializer":"GrammarRegistry","grammarOverridesByPath":{}},"project":{"paths":["/home/qba/work/bpartner"],"buffers":[{"text":"module Api\n  module V1\n    module Admin\n      class PartnerApplicationsController < AdminController\n        respond_to :json\n\n        before_filter { @current_admin = current_admin }\n\n        def show\n          @application = PartnerApplication.by_company(current_company).find(params[:id])\n          authorize @application\n        end\n\n        def by_channel_id\n          @application = YoutubeAccount.by_company(current_company).by_channel_id(params[:id]).active_application\n          authorize @application, :show?\n          render :show\n        end\n\n        def create\n          @youtube_account = (user_id.present? && YoutubeAccount.by_channel_id(user_id)) ||\n            YoutubeAccount.new(user_id: user_id, network_id: network_id, username: user_id)\n          authorize @youtube_account\n          return failed(@youtube_account, :youtube_account) unless @youtube_account.update_attributes(youtube_account_params)\n\n          @user = @youtube_account.user.presence || User.new(youtube_account_id: @youtube_account.id)\n          @user.assign_attributes(user_params)\n\n          if @user.changed?\n            @user.validate_account = true\n            return failed(@user, :user) unless @user.update_attributes(user_params)\n          end\n\n          external_contract = params[:application].delete(:external_contract)\n          external_contract_signed_at = params[:application].delete(:external_contract_signed_at)\n          external_contract_link = params[:application].delete(:external_contract_link)\n          external_contract_comments = params[:application].delete(:external_contract_comments)\n          @application = @youtube_account.active_application || PartnerApplication.new(youtube_account_id: @youtube_account.id)\n          return failed(@application, :application) unless @application.update_attributes(application_params)\n          @application.update_external_contract!(external_contract, external_contract_signed_at, external_contract_link, external_contract_comments)\n\n          render :show\n        end\n\n        def update\n          #TODO OMA: update and create are two different things, should be treated different.\n          create\n        end\n\n        protected\n\n        def failed(obj, namespace)\n          render json: { errors: { namespace => obj.errors }}, status: :unprocessable_entity\n        end\n\n        def user_id\n          params[:youtube_account][:user_id]\n        end\n\n        def network_id\n          params[:application][:network_id]\n        end\n\n        def youtube_account_params\n          fields = [:user_id, :channel_category_id, :block_messaging,\n            :payment_counter_visible]\n          fields += [:percentage, :network_percentage, :aggregator_percentage] if current_admin.has_permission?(Permission::PERCENTAGES)\n\n          params.require(:youtube_account).permit(*fields)\n        end\n\n        def user_params\n          params.require(:user).permit(:full_name, :email, :paypal_email,\n            :skype_name, :birth_date, :country_code, :paypal_exempt, :language)\n        end\n\n        def application_params\n          params.require(:application).permit(:daily_views, :music_info, :email, :legacy_custom_id,\n            :admin_notes, :aggregator_id, :network_id, :state, :recruiter_code,\n            :facebook_username, :facebook_friends, :twitter_username, :twitter_followers,\n            :bank_account, :bank_name, :bank_iban, :bank_swift,\n            :instagram_username, :instagram_followers, :vine_username, :vine_followers, :gaming, gaming: [])\n        end\n      end\n    end\n  end\nend\n","markerStore":{"nextMarkerId":51,"markersById":{"0":{"range":{"start":{"row":73,"column":73},"end":{"row":73,"column":73}},"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":{"start":{"row":73,"column":0},"end":{"row":74,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}},"version":2},"history":{"version":2,"nextCheckpointId":30,"undoStack":[{"type":"checkpoint","id":2,"snapshot":{"0":{"range":[[73,67],[73,67]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"3":{"range":[[73,67],[73,68]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"4":{"range":[[72,38],[72,39]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[73,67],[73,67]],"newRange":[[73,67],[73,68]],"oldText":"","newText":","}},{"type":"change","content":{"oldRange":[[73,68],[73,68]],"newRange":[[73,68],[73,69]],"oldText":"","newText":" "}},{"type":"checkpoint","id":5,"snapshot":{"0":{"range":[[73,69],[73,69]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":6,"snapshot":{"0":{"range":[[73,69],[73,69]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"11":{"range":[[73,69],[73,70]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"12":{"range":[[72,38],[72,39]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap","maintainHistory":true},"13":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[73,69],[73,69]],"newRange":[[73,69],[73,70]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[73,70],[73,70]],"newRange":[[73,70],[73,71]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[73,71],[73,71]],"newRange":[[73,71],[73,72]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[73,72],[73,72]],"newRange":[[73,72],[73,73]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[73,73],[73,73]],"newRange":[[73,73],[73,74]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[73,74],[73,74]],"newRange":[[73,74],[73,75]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[73,75],[73,75]],"newRange":[[73,75],[73,76]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[73,76],[73,76]],"newRange":[[73,76],[73,77]],"oldText":"","newText":"e"}},{"type":"checkpoint","id":21,"snapshot":{"0":{"range":[[73,77],[73,77]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"13":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":22,"snapshot":{"0":{"range":[[73,69],[73,69]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"47":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"change","content":{"oldRange":[[73,69],[73,69]],"newRange":[[73,69],[73,70]],"oldText":"","newText":":"}},{"type":"checkpoint","id":23,"snapshot":{"0":{"range":[[73,70],[73,70]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"47":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":24,"snapshot":{"0":{"range":[[73,70],[73,70]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":25,"snapshot":{"0":{"range":[[73,70],[73,70]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":26,"snapshot":{"0":{"range":[[73,70],[73,70]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":27,"snapshot":{"0":{"range":[[73,70],[73,70]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":28,"snapshot":{"0":{"range":[[73,73],[73,73]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}},{"type":"checkpoint","id":29,"snapshot":{"0":{"range":[[73,73],[73,73]],"properties":{"type":"selection","editorId":13,"goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never","maintainHistory":true},"49":{"range":[[73,0],[74,0]],"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never","maintainHistory":true}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/qba/work/bpartner/app/controllers/api/v1/admin/partner_applications_controller.rb","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"10036389bb61ea8f498dace71ecc2d5ba3eab55f","deserializer":"TextBuffer","version":2}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"id":3,"items":[{"id":13,"softTabs":true,"displayBuffer":{"id":14,"softWrapped":false,"scrollTop":0,"scrollLeft":30,"tokenizedBuffer":{"bufferPath":"/home/qba/work/bpartner/app/controllers/api/v1/admin/partner_applications_controller.rb","largeFileMode":false,"deserializer":"TokenizedBuffer"},"largeFileMode":false,"deserializer":"DisplayBuffer"},"deserializer":"TextEditor"},{"deserializer":"WelcomeView"}],"activeItemURI":"/home/qba/work/bpartner/app/controllers/api/v1/admin/partner_applications_controller.rb","focused":true,"flexScale":1,"deserializer":"Pane"},"activePaneId":3,"deserializer":"PaneContainer","version":1},"fullScreen":false,"packagesWithActiveGrammars":["language-ruby","language-hyperlink","language-todo"],"deserializer":"Workspace"},"packageStates":{"find-and-replace":{"viewState":"","modelState":{"useRegex":false,"inCurrentSelection":false,"caseSensitive":false,"wholeWord":false},"projectViewState":"","resultsModelState":{"useRegex":false,"caseSensitive":false},"findHistory":["language","current_user","current_admin","pindit","pundit"],"replaceHistory":[],"pathsHistory":[]},"fuzzy-finder":{"/home/qba/work/bpartner/app/controllers/api/v1/admin/partner_applications_controller.rb":1436444994693},"keybinding-resolver":{},"metrics":{"sessionLength":420313},"tabs":[{}],"tree-view":{"directoryExpansionStates":{"/home/qba/work/bpartner":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"app":{"isExpanded":false,"entries":{}},"bin":{"isExpanded":false,"entries":{}},"config":{"isExpanded":false,"entries":{}},"db":{"isExpanded":false,"entries":{}},"doc":{"isExpanded":false,"entries":{}},"import":{"isExpanded":false,"entries":{}},"lib":{"isExpanded":false,"entries":{}},"log":{"isExpanded":false,"entries":{}},"mockups":{"isExpanded":false,"entries":{}},"public":{"isExpanded":false,"entries":{}},"script":{"isExpanded":false,"entries":{}},"spec":{"isExpanded":false,"entries":{}},"tmp":{"isExpanded":false,"entries":{}},"vendor":{"isExpanded":false,"entries":{}}}}},"selectedPath":"/home/qba/work/bpartner/app","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200}}}